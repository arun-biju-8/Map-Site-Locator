<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />

    <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
        }

        #map_86102898d774a3266f69b9c0dbb94b05 {
            position: relative;
            width: 100.0%;
            height: 80vh;
            left: 0.0%;
            top: 0.0%;
        }

        .leaflet-container {
            font-size: 1rem;
        }
    </style>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

</head>

<body>
    <div id="container">
        <div id="header">
            <h1>Map Application</h1>
            <input type="text" id="location-input" placeholder="Enter a place name" />
            <button id="search-btn">Search Location</button>
            <button id="refresh-btn">Refresh Map</button>
            <button id="clear-btn">Clear Fields</button>
        </div>
        <div class="folium-map" id="map_86102898d774a3266f69b9c0dbb94b05"></div>
    </div>
</body>
<script>
    // Initialize map with OpenLayers
    var map = new ol.Map({
        target: 'map_86102898d774a3266f69b9c0dbb94b05',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([-122.4194, 37.7749]),
            zoom: 12
        })
    });

    // Marker
    var markerFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([-122.4194, 37.7749])),
        name: 'San Francisco'
    });

    var markerSource = new ol.source.Vector({
        features: [markerFeature]
    });

    var markerLayer = new ol.layer.Vector({
        source: markerSource
    });

    map.addLayer(markerLayer);

    // Popup
    var popupElement = document.createElement('div');
    popupElement.innerHTML = 'San Francisco';
    popupElement.style.display = 'none';
    popupElement.style.backgroundColor = 'white';
    popupElement.style.border = '1px solid black';
    popupElement.style.padding = '5px';
    document.body.appendChild(popupElement);

    var popup = new ol.Overlay({
        element: popupElement,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -50]
    });

    map.addOverlay(popup);

    // Show popup on click
    map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature;
        });
        if (feature) {
            var coordinates = feature.getGeometry().getCoordinates();
            popup.setPosition(coordinates);
            popupElement.innerHTML = feature.get('name');
            popupElement.style.display = 'block';
        } else {
            popupElement.style.display = 'none';
        }
    });

    // Draw source and layer
    var drawSource = new ol.source.Vector();
    var drawLayer = new ol.layer.Vector({
        source: drawSource,
        style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.3)'
            }),
            stroke: new ol.style.Stroke({
                color: 'red',
                width: 3
            })
        })
    });
    map.addLayer(drawLayer);

    // Draw interactions
    var drawPolygon = new ol.interaction.Draw({
        source: drawSource,
        type: 'Polygon'
    });

    var drawRectangle = new ol.interaction.Draw({
        source: drawSource,
        type: 'Circle',
        geometryFunction: ol.interaction.Draw.createBox()
    });

    map.addInteraction(drawPolygon);
    map.addInteraction(drawRectangle);

    // Clear fields button
    document.getElementById('clear-btn').addEventListener('click', function() {
        drawSource.clear();
    });

    // Geocoding function
    async function searchLocation() {
        const query = document.getElementById('location-input').value;
        if (!query) return;

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await response.json();
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                const placeName = data[0].display_name;

                // Update map center
                map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
                map.getView().setZoom(12);

                // Update marker
                markerFeature.getGeometry().setCoordinates(ol.proj.fromLonLat([lon, lat]));
                markerFeature.set('name', placeName);

                // Show popup
                popup.setPosition(ol.proj.fromLonLat([lon, lat]));
                popupElement.innerHTML = placeName;
                popupElement.style.display = 'block';
            } else {
                alert('Location not found');
            }
        } catch (error) {
            console.error('Geocoding error:', error);
            alert('Error searching location');
        }
    }

    // Add event listener to search button
    document.getElementById('search-btn').addEventListener('click', searchLocation);

    // Allow enter key in input
    document.getElementById('location-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });

</script>

</html>